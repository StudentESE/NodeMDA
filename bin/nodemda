#!/usr/bin/env node
'use strict';

const program = require('commander');
const NodeMDA = require('nodemda');
const path = require('path');

const DEFAULT_PLATFORM = "javascript-es6";

// var winston = require('winston');
// winston.level = 'debug';

program
   .version('1.0.0');



program
   .command('generate <modelFileName>')
   .alias("gen")
   .usage("nodemda generate [options] <modelFileName>")
   .description("Generate code from the specified model file")
   .option('-o, --output <outputDirectory>','The output directory')
   .option('-r, --reader <readerModuleName>','Name of a module that will act as the NodeMDA.Reader')
   .option('-p, --platform <platformName>','Name of the platform plugin to use')
   .action(function(fileName) {

                if (program.platform) {
                    NodeMDA.Options.platform = program.platform; 
				}
				else {
				    NodeMDA.Options.platform = DEFAULT_PLATFORM;
				}
				
				if (program.output) {
					NodeMDA.Options.output = program.output;				
				}
				
				if (program.reader) {
					NodeMDA.Meta.Reader = require(program.reader);			
				}
				else {
					NodeMDA.Meta.Reader = require('nodemda-staruml');			
				}
				
    			NodeMDA.gen(fileName);
			});

program
	.command('init')
    .description("Initialize current directory for project development")
    .option('-p, --platform <platformName>','Name of the platform plugin to use')
	.action(function() {
		console.log('TODO: Initialize the project by creating a model dir and copying model from the platform');
	});


program
	.command('dirs')
    .description("Shows the absolute paths to the directories that NodeMDA will use when generating code.")
    .option('-p, --platform <platformName>','Name of the platform plugin to use')
	.action(function() {

        if (program.platform) {
            NodeMDA.Options.platform = program.platform; 
		}
		else {
		    NodeMDA.Options.platform = DEFAULT_PLATFORM;
		}

		console.log(`Current working directory is ${process.cwd()}`);
		console.log(`This nodemda CLI is running from ${__dirname}`);
		console.log(`NodeMDA is running from ${NodeMDA.getNodeMDADir()}`);
		try {
		   console.log(`The platform ${NodeMDA.Options.platform} is located at ${NodeMDA.getPlatformDir()}`);
		}
		catch (error) {
			console.log(`\n\n**ERROR** - can not use platform plugin ${NodeMDA.Options.platform}: ${error.message}\n\n`);
		}
		console.log(`Output will be written to ${path.resolve(NodeMDA.Options.output)}`);

	});


program.parse(process.argv);


if (!process.argv.slice(2).length) {
   program.outputHelp();
}
